---
- name: Install zsh
  ansible.builtin.apt:
    name: zsh
    state: present
  become: true

- name: Add authorized keys
  ansible.posix.authorized_key:
    user: "{{ item.0.unixname }}"
    key: "{{ item.1 }}"
    state: present
  become: true
  loop: "{{ users | subelements('ssh_keys') }}"

- name: Add user
  ansible.builtin.user:
    name: "{{ item.unixname }}"
    shell: /bin/zsh
    groups:
      - sudo
      - adm
      - staff

    append: true
    password: "!"
  become: true
  loop: "{{ users }}"

- name: Configure zsh
  become: true
  ansible.builtin.copy:
    dest: "/home/{{ item.unixname }}/.zshrc"
    content: ""
    owner: "{{ item.unixname }}"
    group: "{{ item.unixname }}"
    mode: "0644"
  loop: "{{ users }}"
